# 0001 â€“ Fullstack Repo Audit and Quality Improvement Plan

Brief

A pre-implementation audit to surface bugs, drawbacks, and code quality improvements across the monorepo before building the real app. Scope covers `apps/api`, `apps/web`, `packages/db`, and `packages/validators`, plus root tooling.

Relevant files and functions

- API (`apps/api`)
  - `apps/api/src/index.ts`
    - `validate<T>()` Zod middleware
    - Route handlers: `GET /health`, `POST /users`, `GET /users`
    - Error middleware: `app.use((err, _req, res) => ...)`
  - `apps/api/package.json` scripts and deps
  - `apps/api/tsconfig.json` build outDir
  - `apps/api/src/smoke.test.ts` baseline test
- DB (`packages/db`)
  - `packages/db/src/schema.ts` table `users`
  - `packages/db/src/client.ts` Postgres client + Drizzle
  - `packages/db/drizzle.config.ts` kit config
  - `packages/db/package.json` scripts and deps
- Validators (`packages/validators`)
  - `packages/validators/src/user.ts` Zod `User`, `CreateUserInput`
  - `packages/validators/src/index.ts` exports
- Web (`apps/web`)
  - `apps/web/src/App.tsx` React Query health + users fetch
  - `apps/web/src/main.tsx` QueryClientProvider
  - `apps/web/src/lib/utils.ts` `cn()` helper + test
  - `apps/web/src/components/ui/button.tsx` shadcn/ui button
  - `apps/web/vite.config.ts`, `tailwind.config.ts`, `tsconfig.json`
- Root
  - `package.json` workspaces, scripts, lint-staged
  - `eslint.config.js`, `prettier.config.mjs`, `turbo.json`
  - `render.yaml` deploy for API
  - `.cursor/rules/shared.mdc`, `AGENTS.md`, `README.md`

Findings and issues

API

- Missing request typing: `// @ts-expect-error` used to stash parsed body on `req.valid` in `apps/api/src/index.ts`. This bypasses type safety.
- Error middleware signature: lacks `next` param; Express 5 supports 3- or 4-arg error handlers, but including `next` avoids type ambiguity and aligns with middleware shape.
- Logging: `pino-http` is installed but unused; no request logging.
- Env handling: `DATABASE_URL!` non-null assertion in `packages/db/src/client.ts` may crash at import-time; better to validate early and throw with guidance.
- CORS/Helmet defaults ok, but no explicit origin config or security headers tuning.

DB

- `createdAt` uses `timestamp(..., { mode: 'string' })`; API and validators align on `string`, but consider `date` mode for stronger typing and transform at the boundary.
- Migrations exist (`packages/db/drizzle/*`), but no seeding utility.

Validators

- `User.name` is `nullable().optional()` but `CreateUserInput.name` is optional non-nullable string. API maps `name ?? null`, which is fine; ensure consistency in DTOs and DB nullability.
- Validators package is published as TypeScript entry points; tooling is fine for workspaces.

Web

- Error handling: React Query `queryFn`s do not check `res.ok`; potential silent failures if API returns 4xx/5xx.
- Missing `VITE_API_URL` fallback or dev default; could use `import.meta.env.VITE_API_URL ?? '/api'` or proxy.
- No Suspense/loading/error states; raw JSON in `<pre>` is fine for a scaffold but not UX-friendly.
- Tailwind and shadcn setup is correct; `button.tsx` follows shadcn patterns.

Tooling/Quality

- ESLint config is flat and reasonable. Ensure 0 warnings policy enforced in CI (present).
- Prettier config present. lint-staged formats TS/JSON/CSS/MD.
- Vitest present; only a smoke test in API and a small util test in web.
- `render.yaml` deploys only API; no web deployment config or API health check route path assertions.

Planned improvements (prioritized)

1. Type-safe validation flow in API

- Add a Request augmentation type and replace `@ts-expect-error`.
- Introduce `ValidatedRequest<TSchema>` or augment `express.Request` via a local `types/express.d.ts` that adds `valid?: z.infer<T>`. Prefer a generic middleware return helper to avoid global mutation.
- Update `apps/api/src/index.ts` to consume typed `req.valid` without ts-ignore.

2. Harden error handling and logging

- Convert error middleware to 4-arg signature `(err, _req, res, _next)` and keep JSON `{ message }`.
- Add `pino-http` middleware with redaction of `authorization`, `cookie`, and any secrets.
- Ensure validation failures return 400 with `zodError.format()` (already implemented); add a catch-all 404 route.

3. Safe env initialization

- In `packages/db/src/client.ts`, validate `process.env.DATABASE_URL` at startup, throw a descriptive error if missing, and avoid `!` non-null assertion.
- Optionally, add a tiny runtime validator using Zod for env.

4. Web fetch robustness and UX

- In `apps/web/src/App.tsx`, check `res.ok` and throw to let React Query surface errors; render loading and error states.
- Add a small `.env.example` and dev fallback for `VITE_API_URL` or Vite proxy config.
- Extract API base to a helper in `src/lib/api.ts`.

5. Schema and DTO consistency

- Decide on `createdAt` type strategy: stay as string everywhere or migrate to JS `Date` in API/validators and serialize at the edge. If switching, update `validators` and any API serialization.
- Confirm `name` optional/nullable semantics across DB, validator, and API mapping.

6. Testing and CI coverage

- Add API integration tests with Vitest for `/health`, `/users` POST/GET, including 400 on invalid body.
- Add web component test for `Button` variants and a basic data fetching hook test with MSW.
- Add a minimal GitHub Actions workflow to run `typecheck`, `lint`, and `test` on PRs.

7. Security and config

- Tighten CORS to known origins in non-dev.
- Helmet: enable sensible policies (e.g., `crossOriginEmbedderPolicy: false` for dev if needed) and configure CSP for production.
- Ensure secrets are never logged; configure pino redaction.

8. Developer experience

- Add `apps/api/.env.example` and root `.env.example` with `DATABASE_URL` and `PORT`.
- Add `README` sections linking to Drizzle migrations and validators usage patterns.
- Add `npm run format` script and hook into lint-staged for TS formatting via Prettier.

Step-by-step changes

API

- Edit `apps/api/src/index.ts`:
  - Replace `@ts-expect-error` by introducing a `validate` middleware that attaches parsed data to `res.locals.valid` (safer) or by augmenting `express` types locally.
  - Switch error middleware to `(err, _req, res, _next)`.
  - Add `import pinoHttp from 'pino-http'` and `app.use(pinoHttp({ redact: ['req.headers.authorization', 'req.headers.cookie'] }))`.
  - Add 404 handler after routes.

DB

- Edit `packages/db/src/client.ts` to validate `DATABASE_URL` and throw with a clear message if missing.
- Consider adding `date` mode for timestamps in schema and harmonize validators if chosen.

Validators

- If DB timestamp type changes, update `User.createdAt` accordingly.
- Optionally add `updateUser` DTO for future endpoints.

Web

- Edit `apps/web/src/App.tsx` to handle loading and error states and check `res.ok`.
- Add `apps/web/src/lib/api.ts` to centralize API base URL and fetch helper.
- Add `.env.example` in `apps/web/` with `VITE_API_URL=http://localhost:3000`.

Tooling

- Add GitHub Actions workflow `.github/workflows/ci.yml` to run `npm ci`, `npm run typecheck`, `npm run lint`, `npm test`.
- Add `format` script at root: `prettier --write .` and include in docs.

Notes

- Keep using Drizzle for all DB access; no `@supabase/supabase-js` in API data paths.
- Maintain 0 ESLint warnings policy; fix new ones introduced by changes.
- Prefer optional chaining and `??` per conventions.
